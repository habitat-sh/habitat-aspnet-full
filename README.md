# Habitat ASP.NET Full Framework sample application

This is a sample ASP.NET MVC Full Framework IIS based application with accompanying Habitat plan, hooks, and configuration (see the habitat directory). The application itself is the exact same application generated by File/New/Project and choosing the C# ASP.NET MVC application inside of [Visual Studio 2015 Community Edition](https://www.visualstudio.com/).

## Challenges of Full Framework runtime and IIS applications with Habitat

### .Net
The .Net full framework binaries are expected to reside in a single, unconfigurable machine scoped location and user deployed binaries may possibly be located in a machine wide assembly repository (the Global Assembly Cache). Further, version updates to .Net are known as "in place" updates which add functionality and bug fixes on top of previous versions of the latest CLR (currently 4.0). In short, isolating the .Net runtime to `/hab/pkgs` is not feasible. There are [undocumented ways](https://github.com/habitat-sh/net-habitat) you could isolate it but that could possibly lead to scenarios that are very difficult to debug for .Net developers who are accustomed to how .Net is typically structured and how it probes for assemblies.

Note that the new .Net Core framework is a completely different story and works quite nicely as an isolatable Habitat package. See this sample .Net Core Habitat plan.

### IIS
Like the .Net full framework, IIS (Windows Internet Information Services) cannot be packaged as a portable set of binaries in your Habitat package cache. IIS ships embedded in the OS itself. Traditionally, when you want to upgrade IIS, you upgrade Windows. IIS is installed as a Windows Feature or "role" on server SKUs.

The IIS application process model allow applications to be run inside of "pools" each which run in their own process. Applications may (but not usually in practice) share the same process. These processes are not invoked by a user/script. IIS itself runs as a windows service and lauches these processes on its own. So what would a Habitat run hook look like if there is no process to kick off the service?

## Plan "Compromises"
In order to overcome the above challenges, we need to take a different approach to how we package .NET Full Framework IIS applications:

### No .Net-Full or IIS package
~~We just are not going to try and package these and we won't feel bad about ourselves.~~

~~We will let our Provisioner or Configuration Management tool handle those dependencies. Our plans and hooks will assume that the correct .Net runtime version is installed (Windows 2012 and forward comes with .Net 4) and that the necessary IIS featrures are enabled.~~

**UPDATE:** As of Habitat 0.74.0, there is now an `install` hook that allows packages to execute a script upon installation. This means we can now provide packages for .Net full framework runtimes and IIS features. This plan has added these dependencies. In order for the `install` hook to be recognized, the `HAB_FEAT_INSTALL_HOOK` environment variable must be set to any value.

### Our run hook will sleep
Typically having a Hook sleep is an anti-pattern but in the case of an IIS app it makes sense. Our run hooks will simply make sure that our IIS application pool and web sites are present and running. Then it will sleep until the application becomes unresponsive or the service is stopped.

## Building the plan
The Habitat plan uses `Nuget.exe` and `MSBuild.exe` to find dependencies and build the application binaries. We do have a `nuget` plan that packages the `nuget` commandline. ~~However, this plan currently assumes the Visual Studio 2015 build tools are installed. We will be packaging this tool chain soon and thereby remove the dependency of a fully installed Visual Studio.~~ 

**Update:** We now provide `msbuild` tooling plans used by this plan.

## Setting up IIS App Pools, Apps and Sites
Currently its up to the plan author to determine how they want to manage this. There are a couple options:

* Let your Config Management or Provisioner set these up for you (ala Chef).
* Let your run hook determine if these primitives are configured and use PowerShell to talk to IIS and set them up.

This plan takes the second approach. It also includes two ways to do this for the sake of reference. One way uses `AppCmd.exe` and the other uses DSC. Which should you use? Use DSC if your server is installed with [WMF 5](https://www.microsoft.com/en-us/download/details.aspx?id=50395) or higher. This is far superior over `AppCmd.exe`. Note that you will find the DSC Configurations located in `habitat/config`. You will likely only use `AppCmd.exe` if you are on 2008 R2 and cannot upgrade to WMF 5. The run hook in this plan includes example `AppCmd.exe` calls that are commented out in favor of DSC.

## What's next here?

### Package Tool Chain
~~While we won't attempt to package the .Net runtime, I believe the SDK binaries and MSBuild targets can be packaged and will bring some build time delight to building full framework apps in habitat.~~
**Update:** Done!

### Handle .Net Framework and IIS Feature installation
~~Currently we blissfully pretend these exist. It may be nice if our hooks could detect if the framework is missing or IIS features not enabled and set the system right the first time the service is started.~~
**Update:** Done!
